<!DOCTYPE html>
<html>
<head>
  <title>Register - Admin Hub</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: #f5f5f5;
    }
    #main-content {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    padding: 0;
    box-sizing: border-box;
    }
    .card {
      background: #fff;
      padding: 200px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
    }
    h1.amount {
      font-size: 8em;
      margin: 0;
    }
    .btn {
      background: #0078d4;
      color: #fff;
      border: none;
      padding: 10px 18px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      margin: 5px;
      transition: background 0.3s;
    }
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .btn:hover:enabled { background: #005a9e; }
    /* Overlay styles */
    .overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .overlay-content {
      background: #fff;
      padding: 20px;
      border-radius: 6px;
      width: 300px;
      text-align: center;
    }
    .overlay-content input {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .msg {
      color: red;
      font-size: 0.9em;
      height: 1.2em;
    }
    /* Status styles */
    #registerStatus {
      font-weight: bold;
      margin-top: 15px;
      font-size: 1.2em;
    }
    .status-open { color: green; }
    .status-closed { color: red; }
  </style>
</head>
<body>

<div id="main-content">
  <div class="card">
    <h2>Register</h2>
    <h1 id="registerAmount" class="amount">$0.00</h1>
    <div style="margin-top:20px;">
      <button id="toggleRegisterBtn" class="btn" style="display:none;" onclick="submitToggleRegister()">Open Register</button>
      <button id="viewRegisterActionsBtn" class="btn" style="display:none;" onclick="showRegisterActionsOverlay()">View Register Actions</button>
      <button id="addMoneyBtn" class="btn" onclick="openAddMoneyOverlay()">Add Money</button>
      <button id="removeMoneyBtn" class="btn" onclick="openRemoveMoneyOverlay()">Remove Money</button>
      <button class="btn" onclick="window.location.href='adminhub.html'">Return to Hub</button>
      <div id="registerStatus" class="status-closed">CLOSED</div>
    </div>
  </div>
</div>

<div id="moneyOverlay" class="overlay">
  <div class="overlay-content">
    <h3 id="moneyOverlayTitle"></h3>
    <input type="number" id="moneyAmount" placeholder="Enter amount" min="0" step="0.01">
    <div id="moneyMsg" class="msg"></div>
    <button class="btn" onclick="submitMoneyAction()">Submit</button>
    <button class="btn" onclick="closeOverlay('moneyOverlay')">Cancel</button>
  </div>
</div>

<div id="registerActionsOverlay" class="overlay">
  <div class="overlay-content" style="max-width:700px; width:90%;">
    <h3>Register Actions</h3>
    <div id="registerActionsTable"></div>
    <button class="btn" onclick="closeOverlay('registerActionsOverlay')">Close</button>
  </div>
</div>

<!-- Loading overlay -->
<div id="loading-overlay" class="overlay" style="background: rgba(255,255,255,0.8); z-index:2000;">
  <div class="overlay-content" style="background:none; box-shadow:none;">
    <i class="fas fa-spinner fa-spin" style="font-size:2em; color:#0078d4;"></i>
  </div>
</div>

<script>
let registerOpened = false;
let registerAmount = 0;
let currentMoneyAction = null; // 'add' or 'remove'

const registerAccess = localStorage.getItem('registerAccess') || "";

document.addEventListener('DOMContentLoaded', () => {
  loadRegisterData();
  // Show/hide the open/close register button based on access
  const toggleBtn = document.getElementById('toggleRegisterBtn');
  const viewActionsBtn = document.getElementById('viewRegisterActionsBtn');
  if (registerAccess === "ADMIN") {
    toggleBtn.style.display = "";
    viewActionsBtn.style.display = "";
  } else {
    toggleBtn.style.display = "none";
    viewActionsBtn.style.display = "none";
  }
});

function showLoading() {
  document.getElementById('loading-overlay').style.display = 'flex';
}
function hideLoading() {
  document.getElementById('loading-overlay').style.display = 'none';
}
function showOverlay(id) {
  document.getElementById(id).style.display = 'flex';
}
function closeOverlay(id) {
  document.getElementById(id).style.display = 'none';
}

async function loadRegisterData() {
  showLoading();
  try {
    const res = await fetch('https://labelle-co-server.vercel.app/get-register');
    const data = await res.json();
    registerOpened = data.registerOpened;
    registerAmount = data.registerAmount;
    updateUI();
  } catch (err) {
    alert('Error loading register data');
  } finally {
    hideLoading();
  }
}

function updateUI() {
  document.getElementById('registerAmount').textContent = `$${registerAmount.toFixed(2)}`;
  // Only update toggleRegisterBtn if it's visible
  const toggleBtn = document.getElementById('toggleRegisterBtn');
  if (registerAccess === "ADMIN") {
    toggleBtn.textContent = registerOpened ? 'Close Register' : 'Open Register';
  }
  
  // Update status text and color
  const statusEl = document.getElementById('registerStatus');
  if (registerOpened) {
    statusEl.textContent = 'OPEN';
    statusEl.className = 'status-open';
  } else {
    statusEl.textContent = 'CLOSED';
    statusEl.className = 'status-closed';
  }
  
  // Enable/disable buttons
  document.getElementById('addMoneyBtn').disabled = !registerOpened;
  document.getElementById('removeMoneyBtn').disabled = !registerOpened;
}

async function submitToggleRegister() {
  showLoading();
  try {
    const res = await fetch('https://labelle-co-server.vercel.app/toggle-register');
    const data = await res.json();
    registerOpened = data.registerOpened;
    updateUI();
  } catch (err) {
    alert('Error toggling register');
  } finally {
    hideLoading();
  }
}

// Money flows
function openAddMoneyOverlay() {
  currentMoneyAction = 'add';
  setupMoneyOverlay('Add Money');
}
function openRemoveMoneyOverlay() {
  currentMoneyAction = 'remove';
  setupMoneyOverlay(`Remove Money (max $${registerAmount.toFixed(2)})`);
}

function setupMoneyOverlay(title) {
  document.getElementById('moneyOverlayTitle').textContent = title;
  document.getElementById('moneyAmount').value = '';
  document.getElementById('moneyMsg').textContent = '';
  showOverlay('moneyOverlay');
}

async function submitMoneyAction() {
  const amount = parseFloat(document.getElementById('moneyAmount').value);
  if (isNaN(amount) || amount < 0) {
    document.getElementById('moneyMsg').textContent = 'Enter a valid amount';
    return;
  }
  if (!registerOpened) {
    document.getElementById('moneyMsg').textContent = 'Register is closed';
    return;
  }
  if (currentMoneyAction === 'remove' && amount > registerAmount) {
    document.getElementById('moneyMsg').textContent = 'Amount exceeds register total';
    return;
  }
  showLoading();
  closeOverlay('moneyOverlay');
  const endpoint = currentMoneyAction === 'add' ? 'add-money' : 'remove-money';
  const person = localStorage.getItem('registerAccess') || 'UNKNOWN';
  try {
    await fetch(`https://labelle-co-server.vercel.app/${endpoint}`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ amount, person })
    });
    registerAmount += currentMoneyAction === 'add' ? amount : -amount;
    updateUI();
  } catch (err) {
    alert('Error updating register');
  } finally {
    hideLoading();
  }
}

async function showRegisterActionsOverlay() {
  showOverlay('registerActionsOverlay');
  document.getElementById('registerActionsTable').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
  try {
    // Fetch register actions and consignors list
    const [analyticsRes, consignorsRes] = await Promise.all([
      fetch('https://labelle-co-server.vercel.app/get-analytics'),
      fetch('https://labelle-co-server.vercel.app/cosigners')
    ]);
    const analytics = await analyticsRes.json();
    const consignors = await consignorsRes.json();
    const actions = Array.isArray(analytics.registerActions) ? analytics.registerActions : [];
    actions.sort((a, b) => b.date - a.date);

    let html = `<table style="width:100%;border-collapse:collapse;">
      <tr style="background:#f0f0f0;">
        <th style="padding:8px;border-bottom:1px solid #ccc;">Consignor Name</th>
        <th style="padding:8px;border-bottom:1px solid #ccc;">Consignor Email</th>
        <th style="padding:8px;border-bottom:1px solid #ccc;">Amount</th>
        <th style="padding:8px;border-bottom:1px solid #ccc;">Date/Time</th>
      </tr>`;

    for (const action of actions) {
      let name = '';
      let email = '';
      if (action.person === "ADMIN") {
        name = "ADMIN";
        email = "-";
      } else if (typeof action.person === "string" && action.person.includes("@")) {
        email = action.person;
        // Find consignor by email
        const consignor = consignors.find(c => c.email === email);
        name = consignor ? consignor.name : "-";
      } else {
        name = action.person || "-";
        email = "-";
      }
      html += `<tr>
        <td style="padding:8px;border-bottom:1px solid #eee;">${name}</td>
        <td style="padding:8px;border-bottom:1px solid #eee;">${email}</td>
        <td style="padding:8px;border-bottom:1px solid #eee;">${action.amount >= 0 ? '+' : ''}$${Math.abs(action.amount).toFixed(2)}</td>
        <td style="padding:8px;border-bottom:1px solid #eee;">${new Date(action.date).toLocaleString()}</td>
      </tr>`;
    }
    html += '</table>';
    document.getElementById('registerActionsTable').innerHTML = html;
  } catch (err) {
    document.getElementById('registerActionsTable').innerHTML = '<span style="color:red;">Failed to load register actions.</span>';
  }
}

</script>
</body>
</html>
