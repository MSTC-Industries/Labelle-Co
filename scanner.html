<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCANNER APP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      background-color: #ecf0f1;
      min-height: 100vh;
    }
    .sidebar {
      width: 220px;
      background-color: #2c3e50;
      color: white;
      height: 100vh;
      padding-top: 20px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .sidebar a {
      display: block;
      padding: 15px 20px;
      color: white;
      text-decoration: none;
      width: 100%;
      box-sizing: border-box;
      border-radius: 6px;
      margin-bottom: 8px;
      text-align: left;
    }
    .sidebar a:hover {
      background-color: #34495e;
    }
    .main-flex {
      display: flex;
      flex-direction: row;
      gap: 32px;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 32px 0;
      box-sizing: border-box;
    }
    .main-col {
      flex: 2;
      display: flex;
      flex-direction: column;
      gap: 24px;
      min-width: 0;
    }
    .main-side {
      flex: 2;
      display: flex;
      flex-direction: column;
      gap: 24px;
      min-width: 0;
    }
    .card {
      background: white;
      padding: 24px 28px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      width: 100%;
      margin: 0 auto 16px auto;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    h2 {
      margin-bottom: 20px;
      color: #2c3e50;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
      font-size: 16px;
    }
    .btn {
      background-color: #3498db;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 5px;
      margin-top: 16px;
      cursor: pointer;
      width: 100%;
      font-size: 16px;
      transition: background 0.2s;
    }
    .btn.scan-btn {
      background-color: green;
      margin-top: 0;
    }
    .btn.scan-btn:disabled {
      background-color: red !important;
      cursor: not-allowed;
    }
    .btn:hover {
      background-color: #2980b9;
    }
    .form-actions {
      text-align: center;
    }
    .sidebar h2 { color: white; }
    a:hover {
      text-decoration: underline;
    }
    #createMsg {
      margin-top: 15px;
      color: green;
    }
    #reader {
      width: 100%;
      max-width: 400px;
      margin: 0 auto 16px auto;
      border-radius: 8px;
      background: #f4f6f8;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      padding: 12px;
    }
    #barcodeInput {
      font-size: 18px;
      padding: 10px;
      margin-bottom: 10px;
      margin-top: 0;
      width: 100%;
      max-width: 400px;
      box-sizing: border-box;
    }
    #show {
      margin-top: 10px;
      width: 100%;
      max-width: 540px;
      background: #f9f9f9;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      padding: 18px 16px;
      box-sizing: border-box;
    }
    #show h4 {
      margin: 0 0 10px 0;
      font-size: 18px;
      color: #2c3e50;
    }
    #resultsList {
      color: blue;
      list-style: none;
      padding-left: 0;
      margin: 0;
      max-height: 180px;
      overflow-y: auto;
    }
    #resultsList li {
      background: #f9f9f9;
      border: 1px solid #ddd;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 16px;
    }
    #resultsList li strong {
      color: #2c3e50;
    }
    #resultsList button {
      background-color: #e74c3c;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    #resultsList button:hover {
      background-color: #c0392b;
    }
    #orders {
      width: 100%;
      max-width: 540px;
      overflow-x: auto;
      margin: 0 auto;
      box-sizing: border-box;
    }
    #orders table {
      width: 100%;
      min-width: 400px;
      border-collapse: collapse;
      margin-top: 8px;
    }
    #orders th, #orders td {
      padding: 10px 8px;
      border-bottom: 1px solid #eee;
      text-align: left;
      font-size: 15px;
    }
    #orders th {
      background: #f4f6f8;
      font-weight: bold;
    }
    #orders tr:hover {
      background: #f2f6fa;
    }
    #customer-lookup-card {
      max-height: 420px;
      min-height: 220px;
      overflow-y: auto;
    }
    #customersTable {
      max-height: 320px;
      overflow-y: auto;
      margin-top: 8px;
    }
    #customersTable table {
      width: 100%;
      border-collapse: collapse;
      font-size: 15px;
    }
    #customersTable th, #customersTable td {
      padding: 8px 6px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    #customersTable th {
      background: #f4f6f8;
      font-weight: bold;
    }
    #customersTable tr:hover {
      background: #f2f6fa;
    }
    @media (max-width: 1100px) {
      .main-flex {
        flex-direction: column;
        max-width: 100vw;
        gap: 16px;
        padding: 16px 0;
      }
      .main-col, .main-side {
        width: 100%;
        max-width: 99vw;
        gap: 16px;
      }
      .card {
        max-width: 99vw;
        padding: 12px 8px;
        margin: 8px auto;
      }
    }
    @media (max-width: 600px) {
      body {
        flex-direction: column;
        min-height: 100vh;
      }
      .sidebar {
        width: 100%;
        height: auto;
        padding: 10px 0;
        text-align: center;
        position: static;
      }
      .main-flex {
        flex-direction: column;
        padding: 10px 0;
        max-width: 100vw;
        gap: 10px;
      }
      .main-col, .main-side {
        width: 100%;
        max-width: 99vw;
        gap: 10px;
      }
      .card {
        max-width: 99vw;
        padding: 10px 6px;
        margin: 6px auto;
      }
      #customer-lookup-card {
        max-height: 180px;
        min-height: 100px;
      }
      #customersTable {
        max-height: 90px;
      }
    }
    </style>
</head>
<body>
  <div class="sidebar">
    <h2 style="text-align:center;">Labelle-Co</h2>
    <a href="adminhub.html"><i class="fas fa-arrow-left"></i> Back to Hub</a>
  </div>
  <div class="main-flex">
    <div class="main-col">
      <div id="reader"></div>
      <div class="card" style="margin-bottom:0;">
        <label for="barcodeInput">Manual Barcode Entry:</label>
        <input type="text" id="barcodeInput" autofocus placeholder="Scan or enter barcode then press enter">
        <button class="btn scan-btn" onclick="triggerScan()" disabled>Scan</button>
      </div>
      <div id="show" style="display: none;" class="card">
        <h4>Cart</h4>
        <ul id="resultsList"></ul>
      </div>
      <div class="form-actions" style="width:100%;max-width:540px;display:flex;gap:12px;justify-content:center;">
        <button class="btn" onclick="clearScannedBarcodes()" style="max-width:220px;">Clear</button>
        <button class="btn" onclick="removeScannedItemsNoPay()" style="max-width:220px;">Remove From Inventory</button>
        <button class="btn" onclick="html5Qrcode.stop(); initialize()" style="max-width:220px;">Checkout</button>
      </div>
      <div class="card" id="admin-checkout-card">
        <h3>Manual Admin Checkout</h3>
        <form id="checkoutForm" onsubmit="return addManualItemToScannedList(event)">
          <label>Name:
            <input type="text" id="checkoutName" required>
          </label>
          <label>Price:
            <input type="number" id="checkoutPrice" min="0" step="0.01" required>
          </label>
          <label>Quantity:
            <input type="number" id="checkoutQty" min="1" step="1" required>
          </label>
          <label>Profit Split:
            <select id="checkoutProfitSplit">
              <option value="100/0">100/0 (No Consignor)</option>
              <option value="90/10">90/10</option>
              <option value="80/20">80/20</option>
              <option value="70/30">70/30</option>
              <option value="60/40">60/40</option>
              <option value="50/50" selected>50/50</option>
              <option value="40/60">40/60</option>
              <option value="30/70">30/70</option>
              <option value="20/80">20/80</option>
              <option value="10/90">10/90</option>
            </select>
          </label>
          <label>Consignor:
            <select id="checkoutConsignorDropdown"></select>
          </label>
          <button type="submit" class="btn" style="margin-top:16px;">Add Item</button>
          <div id="checkoutMsg" style="color:red;margin-top:8px;"></div>
        </form>
      </div>
      <div id="checkout" style="margin-top: 10px; width:100%;max-width:540px;"></div>
    </div>
    <div class="main-side">
      <div class="card" id="discounts-card">
        <h3>Discounts</h3>
        <label for="discountPercent">Percent Off Each Item (%):</label>
        <input type="number" id="discountPercent" min="0" max="99" value="0">
        <label for="discountFixed">Fixed Amount Off Total ($):</label>
        <input type="number" id="discountFixed" min="0" step="0.01" value="0">
        <div style="font-size:13px;color:#888;margin-top:8px;">
          The fixed amount will be divided evenly among all items in the cart.
        </div>
      </div>
      <div class="card" id="orders"></div>
      <div class="card" id="customer-lookup-card">
        <h3>Customer Lookup</h3>
        <input 
          type="text" 
          id="customerSearch" 
          placeholder="Search by name, phone, or email..." 
          onkeyup="filterCustomers()"
        >
        <div id="customersTable"></div>
      </div>
    </div>
  </div>
  <script src="scanner.js"></script>
  <script src="https://js.stripe.com/basil/stripe.js"></script>

<script>
const stripe = Stripe("pk_test_51RUqjwI71UXMKz4PWxaW4fEWQH6TtyqGKb2oC4odsVxJIWsetUL55eU9wos1KQJ1wxxiJgILTsr7fcuvvypP9ZAD00rWNs4Iip"); //UPDATE
const CLOUD_API_URL = 'https://labelle-co-server.vercel.app/cloud';
let allitems = {};
const scannedItems = {}; // barcode → count

let lastDetectedBarcode = null;
let isPreviewing = false;

if (localStorage.getItem('hubPasswordOk') !== 'true') {
  window.location.href = "adminhub.html";
}

fetch(CLOUD_API_URL)
    .then(res => res.json())
    .then(data => {
        allitems = data;
    })
const html5Qrcode = new Html5Qrcode("reader");
let isScanning = false;

const config = { fps: 10, qrbox: { width: 250, height: 250 } };

html5Qrcode.start(
{ facingMode: "environment" },
config,
(decodedText) => {
    lastDetectedBarcode = decodedText;
    document.querySelector("button.scan-btn").disabled = false;
},
(errorMessage) => {
    // Silent logging or display in UI
}
).then(() => {
isPreviewing = true;
}).catch(err => {
console.error("Camera start failed:", err);
});

const barcodeInput = document.getElementById('barcodeInput');
barcodeInput.addEventListener('keydown', function(event) {
  if (event.key === 'Enter') {
    const barcode = barcodeInput.value.trim();
    if (barcode) {
      handleScan(barcode); // Use the same handler as camera scan
      barcodeInput.value = '';
    }
  }
});

function handleScan(decodedText) {
  let matchedItem = null;

  for (const [page, categories] of Object.entries(allitems)) {
    for (const [category, items] of Object.entries(categories)) {
      for (const [itemName, details] of Object.entries(items)) {
        if (details.barcode === decodedText) {
          matchedItem = { name: itemName, ...details };
          break;
        }
      }
      if (matchedItem) break;
    }
    if (matchedItem) break;
  }

  if (!matchedItem) return;

  const scannedCount = scannedItems[decodedText] || 0;

  if (matchedItem.single && scannedCount > 0) return;
  if (scannedCount >= matchedItem.stock) return;

  scannedItems[decodedText] = scannedCount + 1;

  updateScannedList();
  document.getElementById("show").style.display = "block";
}

function updateScannedList() {
  const list = document.getElementById("resultsList");
  list.innerHTML = '';

  let hasItems = false;
  for (const barcode in scannedItems) {
    let matchedItem = null;
    // Check if it's a manual item
    if (window.manualItems && window.manualItems[barcode]) {
      matchedItem = { ...window.manualItems[barcode] };
    } else {
      for (const [page, categories] of Object.entries(allitems)) {
        for (const [category, items] of Object.entries(categories)) {
          for (const [itemName, details] of Object.entries(items)) {
            if (details.barcode === barcode) {
              matchedItem = { name: itemName, ...details };
              break;
            }
          }
          if (matchedItem) break;
        }
        if (matchedItem) break;
      }
    }

    if (!matchedItem) continue;

    hasItems = true;
    const li = document.createElement("li");
    li.innerHTML = `
      <strong>${matchedItem.name}</strong> — $${matchedItem.price || 0} × ${scannedItems[barcode]}
      <button onclick="removeScannedItem('${barcode}')">Remove</button>
    `;
    list.appendChild(li);
  }

  document.getElementById("show").style.display = hasItems ? "block" : "none";
}

function removeScannedItem(barcode) {
  if (!scannedItems[barcode]) return;

  scannedItems[barcode]--;

  if (scannedItems[barcode] <= 0) {
    delete scannedItems[barcode];
  }

  updateScannedList();

  const list = document.getElementById("resultsList");
  document.getElementById("show").style.display = list.children.length > 0 ? "block" : "none";
}


function clearScannedBarcodes() {
    for (const barcode in scannedItems) {
       delete scannedItems[barcode];
    }
    document.getElementById('resultsList').innerHTML = '';
    document.getElementById('show').style.display = 'none';
}

function triggerScan() {
    if (!lastDetectedBarcode) return;

    handleScan(lastDetectedBarcode);
    lastDetectedBarcode = null;
    document.querySelector("button.scan-btn").disabled = true;
}

function getScannedItemSummary() {
  const summary = [];
  const discountPercent = Math.max(0, Math.min(99, Number(document.getElementById('discountPercent').value) || 0));
  const discountFixed = Math.max(0, Number(document.getElementById('discountFixed').value) || 0);

  // Count total items for fixed discount division
  let totalQty = 0;
  for (const barcode in scannedItems) {
    totalQty += scannedItems[barcode];
  }
  totalQty = Math.max(1, totalQty); // Prevent divide by zero

  for (const barcode in scannedItems) {
    let matchedItem = null;
    if (window.manualItems && window.manualItems[barcode]) {
      matchedItem = { ...window.manualItems[barcode] };
    } else {
      for (const [page, categories] of Object.entries(allitems)) {
        for (const [category, items] of Object.entries(categories)) {
          for (const [itemName, details] of Object.entries(items)) {
            if (details.barcode === barcode) {
              matchedItem = { name: itemName, ...details };
              break;
            }
          }
          if (matchedItem) break;
        }
        if (matchedItem) break;
      }
    }

    if (matchedItem) {
      let price = matchedItem.price || 0;
      // Apply percent discount
      price = price * (1 - discountPercent / 100);
      // Apply fixed discount divided by total quantity
      price = price - (discountFixed / totalQty);
      price = Math.max(0, price); // Prevent negative price
      summary.push({
        name: matchedItem.name,
        price: Math.round(price * 100),
        quantity: scannedItems[barcode]
      });
    }
  }

  summary.push({
    name: "Transaction Fee",
    price: 30,
    quantity: 1
  });

  return summary;
}

async function initialize() {
  // Build cart object: { items: { itemName: quantity } }
  const cart = { items: {} };
  const manualItems = {};
  for (const barcode in scannedItems) {
    let matchedItem = null;
    if (window.manualItems && window.manualItems[barcode]) {
      matchedItem = { ...window.manualItems[barcode] };
      manualItems[barcode] = matchedItem;
    } else {
      for (const [page, categories] of Object.entries(allitems)) {
        for (const [category, items] of Object.entries(categories)) {
          for (const [itemName, details] of Object.entries(items)) {
            if (details.barcode === barcode) {
              matchedItem = { name: itemName, ...details };
              break;
            }
          }
          if (matchedItem) break;
        }
        if (matchedItem) break;
      }
    }
    if (matchedItem) {
      cart.items[matchedItem.name] = scannedItems[barcode];
    }
  }
  cart.manualItems = manualItems; // Add manual items to cart
  localStorage.removeItem("pendingOrder");
  localStorage.setItem("completedCart", JSON.stringify(cart));

  let cartItems = getScannedItemSummary();

  const fetchClientSecret = async () => {
    const response = await fetch("https://labelle-co-server.vercel.app/create-checkout-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ items: cartItems })
    });
    const { clientSecret } = await response.json();
    return clientSecret;
  };

  const checkout = await stripe.initEmbeddedCheckout({
    fetchClientSecret,
  });

  console.log(checkout)

  checkout.mount('#checkout');
}

async function loadOrders() {
  const container = document.getElementById('orders');
  container.innerHTML = 'Loading...';
  try {
    const res = await fetch('https://labelle-co-server.vercel.app/orders');
    const orders = await res.json();
    if (!orders.length) {
      container.innerHTML = '<p>No orders yet.</p>';
      return;
    }
    let html = '<table style="width:100%;min-width:400px;"><tr><th>Name</th><th>Phone</th><th>Email</th><th>Items</th><th>Status</th><th>Actions</th></tr>';
    for (const order of orders) {
      // Calculate profits
      let adminProfit = 0;
      let cosignerProfits = {}; // { email: { name, profit } }
      let itemsHtml = '';
      for (const [itemName, qty] of Object.entries(order.items)) {
        let found = false;
        for (const page in allitems) {
          for (const category in allitems[page]) {
            if (allitems[page][category][itemName]) {
              const itemObj = allitems[page][category][itemName];

              itemsHtml += `${itemName} (${qty})<br>`;
              found = true;
              break;
            }
          }
          if (found) break;
        }
        if (!found) {
          itemsHtml += `${itemName} (${qty})<br>`;
        }
      }

      html += `<tr>
        <td>${order.name}</td>
        <td>${order.phone}</td>
        <td>${order.email}</td>
        <td>${itemsHtml}</td>
        <td>
          ${order.orderType === 'buy' ? 'pickup' : order.orderType === 'hold' ? 'buying' : order.status}
        </td>
        <td>
          <button onclick="cancelOrder(${order.id})">close order (after scanning)</button>
        </td>
      </tr>`;
    }
    html += '</table>';
    container.innerHTML = html;
  } catch (err) {
    container.innerHTML = `<p style="color:red;">Failed to load orders: ${err.message}</p>`;
  }
}

// Cancel order function (copy from admin.js)
async function cancelOrder(orderId) {
  try {
    let orders = await (await fetch('https://labelle-co-server.vercel.app/orders')).json();
    let orderIndex = orders.findIndex(o => o.id === orderId);
    if (orderIndex === -1) throw new Error("Order not found.");
    let order = orders[orderIndex];

    orders.splice(orderIndex, 1);

    await fetch('https://labelle-co-server.vercel.app/orders', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(orders)
    });

    loadOrders();
  } catch (err) {
    alert("Failed to cancel order: " + err.message);
  }
}

document.addEventListener('DOMContentLoaded', loadOrders);

async function removeScannedItemsNoPay() {
  if (Object.keys(scannedItems).length === 0) {
    alert("No scanned items to remove.");
    return;
  }
  // Fetch latest inventory
  let inventory = await (await fetch(CLOUD_API_URL)).json();

  // Build a map of itemName → qty from scannedItems
  const itemQtyMap = {};
  for (const barcode in scannedItems) {
    for (const [page, categories] of Object.entries(inventory)) {
      for (const [category, items] of Object.entries(categories)) {
        for (const [itemName, details] of Object.entries(items)) {
          if (details.barcode === barcode) {
            itemQtyMap[itemName] = (itemQtyMap[itemName] || 0) + scannedItems[barcode];
            break;
          }
        }
      }
    }
  }

  // Remove items using acceptOrder logic (default to 'buy' orderType)
  for (const [itemName, qty] of Object.entries(itemQtyMap)) {
    let found = false;
    for (const page in inventory) {
      for (const category in inventory[page]) {
        if (inventory[page][category][itemName]) {
          let item = inventory[page][category][itemName];
          if ('stock' in item) {
            item.stock = Math.max(0, (item.stock || 0) - qty);
            // You can change 'buy' to 'hold' if needed for your workflow
            if ('itemsBought' in item) {
              item.itemsBought = (item.itemsBought || 0) - qty;
            }
          } else {
            delete inventory[page][category][itemName];
          }
          found = true;
          break;
        }
      }
      if (found) break;
    }
  }

  // Save updated inventory to the cloud
  await fetch(CLOUD_API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(inventory)
  });

  // Clear scanned items
  clearScannedBarcodes();
  alert("Scanned items removed from inventory.");
}

async function loadCustomers() {
  const customersTable = document.getElementById('customersTable');
  customersTable.innerHTML = 'Loading...';
  try {
    const res = await fetch('https://labelle-co-server.vercel.app/get-analytics');
    const analytics = await res.json();
    const customersObj = analytics.customers && typeof analytics.customers === 'object' ? analytics.customers : {};
    let html = `<table>
      <tr><th>Name</th><th>Email</th><th>Phone</th></tr>`;
    for (const [email, info] of Object.entries(customersObj)) {
      html += `<tr>
        <td>${info.name || ''}</td>
        <td>${email}</td>
        <td>${info.phone || ''}</td>
      </tr>`;
    }
    html += '</table>';
    customersTable.innerHTML = html;
  } catch (err) {
    customersTable.innerHTML = `<span style="color:red;">Failed to load customers: ${err.message}</span>`;
  }
}

function filterCustomers() {
  const input = document.getElementById("customerSearch");
  const filter = input.value.toLowerCase();
  const table = document.querySelector("#customersTable table");
  if (!table) return;
  const rows = table.getElementsByTagName("tr");
  for (let i = 1; i < rows.length; i++) { // skip header row
    const nameCell = rows[i].getElementsByTagName("td")[0];
    const emailCell = rows[i].getElementsByTagName("td")[1];
    const phoneCell = rows[i].getElementsByTagName("td")[2];
    let match = false;
    if (nameCell && (nameCell.textContent || nameCell.innerText).toLowerCase().includes(filter)) match = true;
    if (emailCell && (emailCell.textContent || emailCell.innerText).toLowerCase().includes(filter)) match = true;
    if (phoneCell && (phoneCell.textContent || phoneCell.innerText).toLowerCase().includes(filter)) match = true;
    rows[i].style.display = match ? "" : "none";
  }
}

document.addEventListener('DOMContentLoaded', loadCustomers);


async function populateCheckoutConsignorDropdown() {
  const dropdown = document.getElementById('checkoutConsignorDropdown');
  dropdown.innerHTML = '<option value="">-- Select Consignor --</option>';
  try {
    const res = await fetch('https://labelle-co-server.vercel.app/cosigners');
    const cosigners = await res.json();
    cosigners.forEach(c => {
      const option = document.createElement('option');
      option.value = JSON.stringify({ name: c.name, email: c.email });
      option.textContent = `${c.name} (${c.email})`;
      dropdown.appendChild(option);
    });
  } catch (err) {
    dropdown.innerHTML = '<option value="">Error loading cosigners</option>';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  loadCustomers();
  populateCheckoutConsignorDropdown();
});

function addManualItemToScannedList(event) {
  event.preventDefault();
  const name = document.getElementById('checkoutName').value.trim();
  const price = Number(document.getElementById('checkoutPrice').value);
  const qty = Number(document.getElementById('checkoutQty').value);
  let profitSplit = document.getElementById('checkoutProfitSplit').value;
  const cosignerData = JSON.parse(document.getElementById('checkoutConsignorDropdown').value || '{}');
  if (!name || !price || !qty) {
    document.getElementById('checkoutMsg').textContent = "Fill out all fields.";
    return false;
  }
  // If no cosigner, force profitSplit to 100/0
  if (!cosignerData.email) profitSplit = "100/0";

  // Use a synthetic barcode to avoid collision with real barcodes
  const manualBarcode = "manual-" + Date.now() + "-" + Math.floor(Math.random() * 1000000);

  // Store manual item in scannedItems with all details
  scannedItems[manualBarcode] = qty;
  if (!window.manualItems) window.manualItems = {};
  window.manualItems[manualBarcode] = {
    name,
    price,
    profitSplit,
    cosignerName: cosignerData.name,
    cosignerEmail: cosignerData.email
  };

  updateScannedList();
  document.getElementById('checkoutForm').reset();
  document.getElementById('checkoutMsg').textContent = "";
  return false;
}

</script>
</body>
</html>