<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCANNER APP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      background-color: #ecf0f1;
    }
    .sidebar {
      width: 220px;
      background-color: #2c3e50;
      color: white;
      height: 100vh;
      padding-top: 20px;
    }
    .sidebar a {
      display: block;
      padding: 15px 20px;
      color: white;
      text-decoration: none;
    }
    .sidebar a:hover {
      background-color: #34495e;
    }
    .main {
      padding: 40px;
      width: 100%;
      flex-direction: column;
    }
    .card {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      max-width: 500px;
      margin: auto;
    }
    h2 {
      margin-bottom: 20px;
      color: #2c3e50;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    input {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .btn {
      background-color: #3498db;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 5px;
      margin-top: 20px;
      cursor: pointer;
      width: 500px;
    }
    .btn:hover {
      background-color: #2980b9;
    }
    .form-actions {
      text-align: center;
    }
    a {
      color: #3498db;
      text-decoration: none;
    }
    .sidebar h2 { color: white; }
    a:hover {
      text-decoration: underline;
    }
    #createMsg {
      margin-top: 15px;
      color: green;
    }

.scan-btn {
  background-color: green;
}

.scan-btn:disabled {
  background-color: red !important;
  cursor: not-allowed;
}

.scan-btn {
  transition: background-color 0.3s ease;
}

    @media (max-width: 600px) {
  body {
    flex-direction: column;
  }

  .sidebar {
    width: 100%;
    height: auto;
    padding: 10px;
    text-align: center;
  }

  .main {
    padding: 20px;
    width: 100%;
  }

  .btn {
    width: 100%;
  }

  #reader {
    width: 100% !important;
    height: auto;
  }

  .card {
    padding: 20px;
    margin: 10px auto;
  }

  ul#resultsList li {
    font-size: 14px;
  }
}

#resultsList li, .resultlist {
  background: #f9f9f9;
  border: 1px solid #ddd;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#resultsList li strong {
  color: #2c3e50;
}

#resultsList button {
  background-color: #e74c3c;
  border: none;
  color: white;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
}

#resultsList button:hover {
  background-color: #c0392b;
}

/* Responsive orders table */
@media (max-width: 600px) {
  #orders table, #orders th, #orders td {
    font-size: 13px;
    padding: 6px;
  }
  #orders table {
    min-width: 400px;
    width: 100%;
    display: block;
    overflow-x: auto;
  }
}
  </style>
</head>
<body>
    <div class="sidebar">
        <h2 style="text-align:center;">Labelle-Co</h2>
        <a href="adminhub.html"><i class="fas fa-arrow-left"></i> Back to Hub</a>
    </div>
    <div class="main" style="align-content: center;">
        <div id="reader"></div>
        <label for="barcodeInput">Manual Barcode Entry:</label>
        <input type="text" id="barcodeInput" autofocus placeholder="Scan or enter barcode then press enter" style="font-size: 18px; padding: 10px; margin-bottom: 10px;">

        <button class="btn scan-btn" onclick="triggerScan()" disabled>Scan</button>
        <br>
        <div id="show" style="display: none; margin-top: 10px;" class="resultlist">
            <h4>Cart</h4>
            <ul id="resultsList" style="color: blue; list-style: none; padding-left: 0;"></ul>
        </div>
        <br>
        <button class="btn" onclick="clearScannedBarcodes()">Clear</button>
        <br>
        <button class="btn" onclick="removeScannedItemsNoPay()">Remove From Inventory (for pickup orders)</button>
        <br>
        <button class="btn" onclick="html5Qrcode.stop(); initialize()">Checkout</button>
        <br>
        <div id="orders" class="card" style="margin-bottom:20px;overflow-x:auto;"></div>
        <br>
         <div id="checkout" style="margin-top: 10px;">
            <!-- Checkout will insert the payment form here -->
        </div>
    </div>
    <script src="scanner.js"></script>
    <script src="https://js.stripe.com/basil/stripe.js"></script>

<script>
const stripe = Stripe("pk_test_51RUqjwI71UXMKz4PWxaW4fEWQH6TtyqGKb2oC4odsVxJIWsetUL55eU9wos1KQJ1wxxiJgILTsr7fcuvvypP9ZAD00rWNs4Iip"); //UPDATE
const CLOUD_API_URL = 'https://labelle-co-server.vercel.app/cloud';
let allitems = {};
const scannedItems = {}; // barcode → count

let lastDetectedBarcode = null;
let isPreviewing = false;

fetch(CLOUD_API_URL)
    .then(res => res.json())
    .then(data => {
        allitems = data;
    })
const html5Qrcode = new Html5Qrcode("reader");
let isScanning = false;

const config = { fps: 10, qrbox: { width: 250, height: 250 } };

html5Qrcode.start(
{ facingMode: "environment" },
config,
(decodedText) => {
    lastDetectedBarcode = decodedText;
    document.querySelector("button.scan-btn").disabled = false;
},
(errorMessage) => {
    // Silent logging or display in UI
}
).then(() => {
isPreviewing = true;
}).catch(err => {
console.error("Camera start failed:", err);
});

const barcodeInput = document.getElementById('barcodeInput');
barcodeInput.addEventListener('keydown', function(event) {
  if (event.key === 'Enter') {
    const barcode = barcodeInput.value.trim();
    if (barcode) {
      handleScan(barcode); // Use the same handler as camera scan
      barcodeInput.value = '';
    }
  }
});

function handleScan(decodedText) {
  let matchedItem = null;

  for (const [page, categories] of Object.entries(allitems)) {
    for (const [category, items] of Object.entries(categories)) {
      for (const [itemName, details] of Object.entries(items)) {
        if (details.barcode === decodedText) {
          matchedItem = { name: itemName, ...details };
          break;
        }
      }
      if (matchedItem) break;
    }
    if (matchedItem) break;
  }

  if (!matchedItem) return;

  const scannedCount = scannedItems[decodedText] || 0;

  if (matchedItem.single && scannedCount > 0) return;
  if (scannedCount >= matchedItem.stock) return;

  scannedItems[decodedText] = scannedCount + 1;

  updateScannedList();
  document.getElementById("show").style.display = "block";
}

function updateScannedList() {
  const list = document.getElementById("resultsList");
  list.innerHTML = '';

  for (const barcode in scannedItems) {
    let matchedItem = null;
    for (const [page, categories] of Object.entries(allitems)) {
      for (const [category, items] of Object.entries(categories)) {
        for (const [itemName, details] of Object.entries(items)) {
          if (details.barcode === barcode) {
            matchedItem = { name: itemName, ...details };
            break;
          }
        }
        if (matchedItem) break;
      }
      if (matchedItem) break;
    }

    if (!matchedItem) continue;

    const li = document.createElement("li");
    li.innerHTML = `
      <strong>${matchedItem.name}</strong> — $${matchedItem.price || 0} × ${scannedItems[barcode]}
      <button onclick="removeScannedItem('${barcode}')">Remove</button>
    `;
    list.appendChild(li);
  }

}

function removeScannedItem(barcode) {
  if (!scannedItems[barcode]) return;

  scannedItems[barcode]--;

  if (scannedItems[barcode] <= 0) {
    delete scannedItems[barcode];
  }

  updateScannedList();

  const list = document.getElementById("resultsList");
  document.getElementById("show").style.display = list.children.length > 0 ? "block" : "none";
}


function clearScannedBarcodes() {
    for (const barcode in scannedItems) {
       delete scannedItems[barcode];
    }
    document.getElementById('resultsList').innerHTML = '';
    document.getElementById('show').style.display = 'none';
}

function triggerScan() {
    if (!lastDetectedBarcode) return;

    handleScan(lastDetectedBarcode);
    lastDetectedBarcode = null;
    document.querySelector("button.scan-btn").disabled = true;
}

function getScannedItemSummary() {
  const summary = [];

  for (const barcode in scannedItems) {
    let matchedItem = null;
    for (const [page, categories] of Object.entries(allitems)) {
      for (const [category, items] of Object.entries(categories)) {
        for (const [itemName, details] of Object.entries(items)) {
          if (details.barcode === barcode) {
            matchedItem = { name: itemName, ...details };
            break;
          }
        }
        if (matchedItem) break;
      }
      if (matchedItem) break;
    }

    if (matchedItem) {
      summary.push({
        name: matchedItem.name,
        price: Math.round((matchedItem.price || 0) * 100),
        quantity: scannedItems[barcode]
      });
    }
  }

  return summary;
}

async function initialize() {
  // Build cart object: { items: { itemName: quantity } }
  const cart = { items: {} };
  for (const barcode in scannedItems) {
    let matchedItem = null;
    for (const [page, categories] of Object.entries(allitems)) {
      for (const [category, items] of Object.entries(categories)) {
        for (const [itemName, details] of Object.entries(items)) {
          if (details.barcode === barcode) {
            matchedItem = { name: itemName, ...details };
            break;
          }
        }
        if (matchedItem) break;
      }
      if (matchedItem) break;
    }
    if (matchedItem) {
      cart.items[matchedItem.name] = scannedItems[barcode];
    }
  }
  // Save to localStorage for return.js
  localStorage.removeItem("pendingOrder");
  localStorage.setItem("completedCart", JSON.stringify(cart));

  let cartItems = getScannedItemSummary();

  const fetchClientSecret = async () => {
    const response = await fetch("https://labelle-co-server.vercel.app/create-checkout-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ items: cartItems })
    });
    const { clientSecret } = await response.json();
    return clientSecret;
  };

  const checkout = await stripe.initEmbeddedCheckout({
    fetchClientSecret,
  });

  console.log(checkout)

  checkout.mount('#checkout');
}

async function loadOrders() {
  const container = document.getElementById('orders');
  container.innerHTML = 'Loading...';
  try {
    const res = await fetch('https://labelle-co-server.vercel.app/orders');
    const orders = await res.json();
    if (!orders.length) {
      container.innerHTML = '<p>No orders yet.</p>';
      return;
    }
    let html = '<table style="width:100%;min-width:400px;"><tr><th>Name</th><th>Phone</th><th>Email</th><th>Items</th><th>Status</th><th>Actions</th></tr>';
    for (const order of orders) {
      // Calculate profits
      let adminProfit = 0;
      let cosignerProfits = {}; // { email: { name, profit } }
      let itemsHtml = '';
      for (const [itemName, qty] of Object.entries(order.items)) {
        let found = false;
        for (const page in allitems) {
          for (const category in allitems[page]) {
            if (allitems[page][category][itemName]) {
              const itemObj = allitems[page][category][itemName];

              itemsHtml += `${itemName} (${qty})<br>`;
              found = true;
              break;
            }
          }
          if (found) break;
        }
        if (!found) {
          itemsHtml += `${itemName} (${qty})<br>`;
        }
      }

      html += `<tr>
        <td>${order.name}</td>
        <td>${order.phone}</td>
        <td>${order.email}</td>
        <td>${itemsHtml}</td>
        <td>
          ${order.orderType === 'buy' ? 'pickup' : order.orderType === 'hold' ? 'buying' : order.status}
        </td>
        <td>
          <button onclick="cancelOrder(${order.id})">close order (after scanning)</button>
        </td>
      </tr>`;
    }
    html += '</table>';
    container.innerHTML = html;
  } catch (err) {
    container.innerHTML = `<p style="color:red;">Failed to load orders: ${err.message}</p>`;
  }
}

// Cancel order function (copy from admin.js)
async function cancelOrder(orderId) {
  try {
    let orders = await (await fetch('https://labelle-co-server.vercel.app/orders')).json();
    let orderIndex = orders.findIndex(o => o.id === orderId);
    if (orderIndex === -1) throw new Error("Order not found.");
    let order = orders[orderIndex];

    orders.splice(orderIndex, 1);

    await fetch('https://labelle-co-server.vercel.app/orders', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(orders)
    });

    loadOrders();
  } catch (err) {
    alert("Failed to cancel order: " + err.message);
  }
}

document.addEventListener('DOMContentLoaded', loadOrders);

async function removeScannedItemsNoPay() {
  if (Object.keys(scannedItems).length === 0) {
    alert("No scanned items to remove.");
    return;
  }
  // Fetch latest inventory
  let inventory = await (await fetch(CLOUD_API_URL)).json();

  // Build a map of itemName → qty from scannedItems
  const itemQtyMap = {};
  for (const barcode in scannedItems) {
    for (const [page, categories] of Object.entries(inventory)) {
      for (const [category, items] of Object.entries(categories)) {
        for (const [itemName, details] of Object.entries(items)) {
          if (details.barcode === barcode) {
            itemQtyMap[itemName] = (itemQtyMap[itemName] || 0) + scannedItems[barcode];
            break;
          }
        }
      }
    }
  }

  // Remove items using acceptOrder logic (default to 'buy' orderType)
  for (const [itemName, qty] of Object.entries(itemQtyMap)) {
    let found = false;
    for (const page in inventory) {
      for (const category in inventory[page]) {
        if (inventory[page][category][itemName]) {
          let item = inventory[page][category][itemName];
          if ('stock' in item) {
            item.stock = Math.max(0, (item.stock || 0) - qty);
            // You can change 'buy' to 'hold' if needed for your workflow
            if ('itemsBought' in item) {
              item.itemsBought = (item.itemsBought || 0) - qty;
            }
          } else {
            delete inventory[page][category][itemName];
          }
          found = true;
          break;
        }
      }
      if (found) break;
    }
  }

  // Save updated inventory to the cloud
  await fetch(CLOUD_API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(inventory)
  });

  // Clear scanned items
  clearScannedBarcodes();
  alert("Scanned items removed from inventory.");
}

</script>
</body>
</html>