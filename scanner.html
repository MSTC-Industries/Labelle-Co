<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCANNER APP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
/* --- Existing CSS (unchanged rulesets) --- */
body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  display: flex;
  background-color: #ecf0f1;
  min-height: 100vh;
}
.sidebar {
  width: 220px;
  background-color: #2c3e50;
  color: white;
  height: 100vh;
  padding-top: 20px;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.sidebar a {
  display: block;
  padding: 15px 20px;
  color: white;
  text-decoration: none;
  width: 100%;
  box-sizing: border-box;
  border-radius: 6px;
  margin-bottom: 8px;
  text-align: left;
}
.sidebar a:hover {
  background-color: #34495e;
}
/* --- New Layout Classes --- */
.layout-main {
  display: flex;
  flex-direction: row;
  width: 100%;
  min-height: 100vh;
  box-sizing: border-box;
}
.layout-left {
  flex: 2.5;
  display: flex;
  flex-direction: column;
  gap: 24px;
  padding: 32px 16px 32px 0;
  min-width: 0;
}
.layout-right {
  flex: 1.5;
  display: flex;
  flex-direction: column;
  gap: 24px;
  padding: 32px 32px 32px 0;
  min-width: 340px;
  max-width: 420px;
}
/* --- Cart Panel --- */
#cart-panel {
  width: 100%;
  height: 340px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  display: flex;
  flex-direction: column;
  margin-bottom: 0;
  min-width: 320px;
  max-width: 100%;
}
#cart-header {
  padding: 18px 28px 10px 28px;
  font-size: 2rem;
  font-weight: bold;
  color: #2c3e50;
  border-bottom: 1px solid #eee;
  background: #f7f7fa;
}
#cart-list {
  flex: 1 1 auto;
  overflow-y: auto;
  padding: 12px 28px 0 28px;
}
#cart-list ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
#cart-list li {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #f0f0f0;
  padding: 10px 0;
  font-size: 1.1rem;
}
#cart-list li strong {
  color: #2c3e50;
}
#cart-list li button {
  background: #e74c3c;
  color: #fff;
  border: none;
  border-radius: 4px;
  padding: 4px 10px;
  font-size: 0.95em;
  cursor: pointer;
}
#cart-list li button:hover {
  background: #c0392b;
}
#cart-summary {
  padding: 14px 28px 18px 28px;
  border-top: 1px solid #eee;
  background: #f7f7fa;
  font-size: 1.15rem;
}
.cart-summary-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 7px;
}
/* --- Other Section --- */
#other-section {
  width: 100%;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  padding: 24px 28px;
  margin-top: 0;
  min-height: 180px;
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
  gap: 18px;
}
/* --- Barcode Section --- */
#barcode-section {
  width: 100%;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  padding: 18px 20px;
  margin-bottom: 0;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  gap: 10px;
}
#reader {
  width: 100%;
  max-width: 340px;
  margin: 0 auto 0 auto;
  border-radius: 8px;
  background: #f4f6f8;
  box-shadow: 0 1px 4px rgba(0,0,0,0.06);
  padding: 12px;
}
#barcodeInput {
  font-size: 18px;
  padding: 10px;
  margin-bottom: 10px;
  margin-top: 0;
  width: 100%;
  max-width: 340px;
  box-sizing: border-box;
}
#checkout {
  margin-top: 10px;
  width: 100%;
  max-width: 340px;
}
/* --- Responsive --- */
@media (max-width: 1100px) {
  .layout-main {
    flex-direction: column;
    max-width: 100vw;
    gap: 16px;
    padding: 0;
  }
  .layout-left, .layout-right {
    width: 100%;
    max-width: 99vw;
    gap: 16px;
    padding: 16px 0 0 0;
  }
  #cart-panel, #other-section, #barcode-section {
    max-width: 99vw;
    min-width: 0;
  }
}
@media (max-width: 700px) {
  .layout-main {
    flex-direction: column;
    gap: 10px;
    padding: 0;
  }
  .layout-left, .layout-right {
    width: 100%;
    max-width: 99vw;
    gap: 10px;
    padding: 8px 0 0 0;
  }
  #cart-panel, #other-section, #barcode-section {
    max-width: 99vw;
    min-width: 0;
    border-radius: 8px;
    padding: 10px 6px;
  }
  #cart-header, #cart-list, #cart-summary {
    padding-left: 10px;
    padding-right: 10px;
  }
}
/* --- Keep all your other rulesets below (cards, buttons, selects, etc.) --- */
.card {
  background: white;
  padding: 24px 28px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  width: 100%;
  margin: 0 auto 16px auto;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
h2 {
  margin-bottom: 20px;
  color: #2c3e50;
}
label {
  display: block;
  margin-top: 12px;
  font-weight: bold;
}
input, select {
  width: 100%;
  padding: 10px;
  margin-top: 5px;
  border: 1px solid #ccc;
  border-radius: 5px;
  box-sizing: border-box;
  font-size: 16px;
}
.btn {
  background-color: #3498db;
  color: white;
  padding: 12px 20px;
  border: none;
  border-radius: 5px;
  margin-top: 16px;
  cursor: pointer;
  width: 100%;
  font-size: 16px;
  transition: background 0.2s;
}
.btn.scan-btn {
  background-color: green;
  margin-top: 0;
}
.btn.scan-btn:disabled {
  background-color: red !important;
  cursor: not-allowed;
}
.btn:hover {
  background-color: #2980b9;
}
.form-actions {
  text-align: center;
}
.sidebar h2 { color: white; }
a:hover {
  text-decoration: underline;
}
#createMsg {
  margin-top: 15px;
  color: green;
}
#show {
  margin-top: 10px;
  width: 100%;
  max-width: 540px;
  background: #f9f9f9;
  border-radius: 8px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.06);
  padding: 18px 16px;
  box-sizing: border-box;
}
#show h4 {
  margin: 0 0 10px 0;
  font-size: 18px;
  color: #2c3e50;
}
#resultsList {
  color: blue;
  list-style: none;
  padding-left: 0;
  margin: 0;
  max-height: 180px;
  overflow-y: auto;
}
#resultsList li {
  background: #f9f9f9;
  border: 1px solid #ddd;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 16px;
}
#resultsList li strong {
  color: #2c3e50;
}
#resultsList button {
  background-color: #e74c3c;
  border: none;
  color: white;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}
#resultsList button:hover {
  background-color: #c0392b;
}
#orders {
  width: 100%;
  max-width: 540px;
  overflow-x: auto;
  margin: 0 auto;
  box-sizing: border-box;
}
#orders table {
  width: 100%;
  min-width: 400px;
  border-collapse: collapse;
  margin-top: 8px;
}
#orders th, #orders td {
  padding: 10px 8px;
  border-bottom: 1px solid #eee;
  text-align: left;
  font-size: 15px;
}
#orders th {
  background: #f4f6f8;
  font-weight: bold;
}
#orders tr:hover {
  background: #f2f6fa;
}
#customer-lookup-card {
  max-height: 420px;
  min-height: 220px;
  overflow-y: auto;
}
#customersTable {
  max-height: 320px;
  overflow-y: auto;
  margin-top: 8px;
}
#customersTable table {
  width: 100%;
  border-collapse: collapse;
  font-size: 15px;
}
#customersTable th, #customersTable td {
  padding: 8px 6px;
  border-bottom: 1px solid #eee;
  text-align: left;
}
#customersTable th {
  background: #f4f6f8;
  font-weight: bold;
}
#customersTable tr:hover {
  background: #f2f6fa;
}
@media (max-width: 1100px) {
  .main-flex {
    flex-direction: column;
    max-width: 100vw;
    gap: 16px;
    padding: 16px 0;
  }
  .main-col, .main-side {
    width: 100%;
    max-width: 99vw;
    gap: 16px;
  }
  .card {
    max-width: 99vw;
    padding: 12px 8px;
    margin: 8px auto;
  }
}
@media (max-width: 600px) {
  body {
    flex-direction: column;
    min-height: 100vh;
  }
  .sidebar {
    width: 100%;
    height: auto;
    padding: 10px 0;
    text-align: center;
    position: static;
  }
  .main-flex {
    flex-direction: column;
    padding: 10px 0;
    max-width: 100vw;
    gap: 10px;
  }
  .main-col, .main-side {
    width: 100%;
    max-width: 99vw;
    gap: 10px;
  }
  .card {
    max-width: 99vw;
    padding: 10px 6px;
    margin: 6px auto;
  }
  #customer-lookup-card {
    max-height: 180px;
    min-height: 100px;
  }
  #customersTable {
    max-height: 90px;
  }
}
/* --- New/updated layout for bottom row cards --- */
#bottom-row-cards {
  display: flex;
  flex-wrap: wrap;
  gap: 24px;
  margin-top: 24px;
  width: 100%;
  justify-content: flex-start;
}
.bottom-card {
  flex: 1 1 260px;
  min-width: 240px;
  max-width: 340px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  padding: 24px 20px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
@media (max-width: 1200px) {
  #bottom-row-cards {
    gap: 16px;
  }
  .bottom-card {
    min-width: 180px;
    max-width: 99vw;
    padding: 16px 8px;
  }
}
@media (max-width: 900px) {
  #bottom-row-cards {
    flex-direction: column;
    gap: 10px;
  }
  .bottom-card {
    min-width: 0;
    width: 100%;
    max-width: 99vw;
  }
}
#cart-buttons {
  width: 100%;
  margin-top: 18px;
  display: flex;
  gap: 12px;
  justify-content: center;
}
#cart-buttons .btn {
  max-width: 180px;
  flex: 1 1 0;
  margin-top: 0;
}
    </style>
</head>
<body>
  <div class="sidebar">
    <h2 style="text-align:center;">Labelle-Co</h2>
    <a onclick="window.location.href = localStorage.getItem('backFromScanner') || 'adminhub.html'"><i class="fas fa-arrow-left"></i> Back</a>
  </div>
  <div class="layout-main">
    <div class="layout-left">
      <div id="cart-panel">
        <div id="cart-header">Cart</div>
        <div id="cart-list">
          <ul id="resultsList"></ul>
        </div>
        <div id="cart-summary">
          <div id="cart-summary-subtotal" class="cart-summary-row"></div>
          <div id="cart-summary-tax" class="cart-summary-row"></div>
          <div id="cart-summary-total" class="cart-summary-row" style="font-weight:bold;"></div>
        </div>
      </div>
      <div id="bottom-row-cards">
        <div class="bottom-card" id="admin-checkout-card">
          <h3>Manual Admin Checkout</h3>
          <form id="checkoutForm" onsubmit="return addManualItemToScannedList(event)">
            <label>Name:
              <input type="text" id="checkoutName" required>
            </label>
            <label>Price:
              <input type="number" id="checkoutPrice" min="0" step="0.01" required>
            </label>
            <label>Quantity:
              <input type="number" id="checkoutQty" min="1" step="1" required>
            </label>
            <label>Profit Split:
              <select id="checkoutProfitSplit">
                <option value="100/0">100/0 (No Consignor)</option>
                <option value="90/10">90/10</option>
                <option value="80/20">80/20</option>
                <option value="70/30">70/30</option>
                <option value="60/40">60/40</option>
                <option value="50/50" selected>50/50</option>
                <option value="40/60">40/60</option>
                <option value="30/70">30/70</option>
                <option value="20/80">20/80</option>
                <option value="10/90">10/90</option>
              </select>
            </label>
            <label>Consignor:
              <select id="checkoutConsignorDropdown"></select>
            </label>
            <button type="submit" class="btn" style="margin-top:16px;">Add Item</button>
            <div id="checkoutMsg" style="color:red;margin-top:8px;"></div>
          </form>
        </div>
        <div class="bottom-card" id="discounts-card">
          <h3>Discounts</h3>
          <label for="discountPercent">Percent Off Each Item (%):</label>
          <input type="number" id="discountPercent" min="0" max="99" value="0">
          <label for="discountFixed">Fixed Amount Off Total ($):</label>
          <input type="number" id="discountFixed" min="0" step="0.01" value="0">
          <div style="font-size:13px;color:#888;margin-top:8px;">
            The fixed amount will be divided evenly among all items in the cart.
          </div>
        </div>
        <div class="bottom-card" id="orders"></div>
        <div class="bottom-card" id="customer-lookup-card">
          <h3>Customer Lookup</h3>
          <input 
            type="text" 
            id="customerSearch" 
            placeholder="Search by name, phone, or email..." 
            onkeyup="filterCustomers()"
          >
          <div id="customersTable"></div>
        </div>
      </div>
    </div>
    <div class="layout-right">
      <div id="barcode-section">
        <label for="barcodeInput">Manual Barcode Entry:</label>
        <input type="text" id="barcodeInput" autofocus placeholder="Scan or enter barcode then press enter">
        <button class="btn scan-btn" onclick="triggerScan()" disabled>Scan</button>
        <div id="reader"></div>
        <div id="cart-buttons">
          <button class="btn" onclick="clearScannedBarcodes()">Clear</button>
          <button class="btn" onclick="removeScannedItemsNoPay()">Remove From Inventory</button>
          <button class="btn" onclick="html5Qrcode.stop(); initialize()">Checkout</button>
        </div>
      </div>
      <div id="checkout"></div>
    </div>
  </div>
  <script src="scanner.js"></script>
  <script src="https://js.stripe.com/basil/stripe.js"></script>

<script>
const stripe = Stripe("pk_test_51RUqjwI71UXMKz4PWxaW4fEWQH6TtyqGKb2oC4odsVxJIWsetUL55eU9wos1KQJ1wxxiJgILTsr7fcuvvypP9ZAD00rWNs4Iip"); //UPDATE
const CLOUD_API_URL = 'https://labelle-co-server.vercel.app/cloud';
let allitems = {};
const scannedItems = {}; // barcode → count

let lastDetectedBarcode = null;
let isPreviewing = false;

if (localStorage.getItem('hubPasswordOk') !== 'true') {
  window.location.href = "adminhub.html";
}

fetch(CLOUD_API_URL)
    .then(res => res.json())
    .then(data => {
        allitems = data;
    })
const html5Qrcode = new Html5Qrcode("reader");
let isScanning = false;

const config = { fps: 10, qrbox: { width: 250, height: 250 } };

html5Qrcode.start(
{ facingMode: "environment" },
config,
(decodedText) => {
    lastDetectedBarcode = decodedText;
    document.querySelector("button.scan-btn").disabled = false;
},
(errorMessage) => {
    // Silent logging or display in UI
}
).then(() => {
isPreviewing = true;
}).catch(err => {
console.error("Camera start failed:", err);
});

const barcodeInput = document.getElementById('barcodeInput');
barcodeInput.addEventListener('keydown', function(event) {
  if (event.key === 'Enter') {
    const barcode = barcodeInput.value.trim();
    if (barcode) {
      handleScan(barcode); // Use the same handler as camera scan
      barcodeInput.value = '';
    }
  }
});

function handleScan(decodedText) {
  let matchedItem = null;

  for (const [page, categories] of Object.entries(allitems)) {
    for (const [category, items] of Object.entries(categories)) {
      for (const [itemName, details] of Object.entries(items)) {
        if (details.barcode === decodedText) {
          matchedItem = { name: itemName, ...details };
          break;
        }
      }
      if (matchedItem) break;
    }
    if (matchedItem) break;
  }

  if (!matchedItem) return;

  const scannedCount = scannedItems[decodedText] || 0;

  if (matchedItem.single && scannedCount > 0) return;
  if (scannedCount >= matchedItem.stock) return;

  scannedItems[decodedText] = scannedCount + 1;

  updateScannedList();
  document.getElementById("show").style.display = "block";
}

function updateScannedList() {
  const list = document.getElementById("resultsList");
  list.innerHTML = '';

  let subtotal = 0;
  let totalTax = 0;
  let total = 0;

  for (const barcode in scannedItems) {
    let matchedItem = null;
    let isManual = false;
    if (window.manualItems && window.manualItems[barcode]) {
      matchedItem = { ...window.manualItems[barcode] };
      isManual = true;
    } else {
      for (const [page, categories] of Object.entries(allitems)) {
        for (const [category, items] of Object.entries(categories)) {
          for (const [itemName, details] of Object.entries(items)) {
            if (details.barcode === barcode) {
              matchedItem = { name: itemName, ...details };
              break;
            }
          }
          if (matchedItem) break;
        }
        if (matchedItem) break;
      }
    }

    if (!matchedItem) continue;

    const qty = scannedItems[barcode];
    let price = matchedItem.price || 0;

    // Discounts
    const discountPercent = Math.max(0, Math.min(99, Number(document.getElementById('discountPercent')?.value) || 0));
    const discountFixed = Math.max(0, Number(document.getElementById('discountFixed')?.value) || 0);
    let totalQty = 0;
    for (const b in scannedItems) totalQty += scannedItems[b];
    totalQty = Math.max(1, totalQty);

    price = price * (1 - discountPercent / 100);
    price = price - (discountFixed / totalQty);
    price = Math.max(0, price);

    let taxed = isManual || !!matchedItem.taxed;
    let taxAmount = taxed ? price * 0.06 * qty : 0;
    let rowTotal = price * qty;

    subtotal += rowTotal;
    totalTax += taxAmount;

    const li = document.createElement("li");
    li.innerHTML = `
      <span><strong>${matchedItem.name}</strong> — $${(price).toFixed(2)} × ${qty}</span>
      <button onclick="removeScannedItem('${barcode}')">Remove</button>
    `;
    list.appendChild(li);
  }

  total = subtotal + totalTax;

  // Update summary at the bottom of the cart
  document.getElementById('cart-summary-subtotal').innerHTML =
    `<span>Subtotal:</span><span>$${subtotal.toFixed(2)}</span>`;
  document.getElementById('cart-summary-tax').innerHTML =
    `<span>Tax:</span><span>$${totalTax.toFixed(2)}</span>`;
  document.getElementById('cart-summary-total').innerHTML =
    `<span>Total:</span><span>$${total.toFixed(2)}</span>`;
}

function removeScannedItem(barcode) {
  if (!scannedItems[barcode]) return;

  scannedItems[barcode]--;

  if (scannedItems[barcode] <= 0) {
    delete scannedItems[barcode];
  }

  updateScannedList();

  const list = document.getElementById("resultsList");
  document.getElementById("show").style.display = list.children.length > 0 ? "block" : "none";
}


function clearScannedBarcodes() {
    for (const barcode in scannedItems) {
       delete scannedItems[barcode];
    }
    document.getElementById('resultsList').innerHTML = '';
    document.getElementById('show').style.display = 'none';
}

function triggerScan() {
    if (!lastDetectedBarcode) return;

    handleScan(lastDetectedBarcode);
    lastDetectedBarcode = null;
    document.querySelector("button.scan-btn").disabled = true;
}

function getScannedItemSummary() {
  const summary = [];
  const discountPercent = Math.max(0, Math.min(99, Number(document.getElementById('discountPercent').value) || 0));
  const discountFixed = Math.max(0, Number(document.getElementById('discountFixed').value) || 0);

  // Count total items for fixed discount division
  let totalQty = 0;
  for (const barcode in scannedItems) {
    totalQty += scannedItems[barcode];
  }
  totalQty = Math.max(1, totalQty); // Prevent divide by zero

  for (const barcode in scannedItems) {
    let matchedItem = null;
    let isManual = false;
    if (window.manualItems && window.manualItems[barcode]) {
      matchedItem = { ...window.manualItems[barcode] };
      isManual = true;
    } else {
      for (const [page, categories] of Object.entries(allitems)) {
        for (const [category, items] of Object.entries(categories)) {
          for (const [itemName, details] of Object.entries(items)) {
            if (details.barcode === barcode) {
              matchedItem = { name: itemName, ...details };
              break;
            }
          }
          if (matchedItem) break;
        }
        if (matchedItem) break;
      }
    }

    if (matchedItem) {
      let price = matchedItem.price || 0;
      // Apply percent discount
      price = price * (1 - discountPercent / 100);
      // Apply fixed discount divided by total quantity
      price = price - (discountFixed / totalQty);
      price = Math.max(0, price); // Prevent negative price

      // Apply 6% tax if manual or taxed
      let taxed = isManual || !!matchedItem.taxed;
      let taxAmount = taxed ? price * 0.06 : 0;
      let finalPrice = price + taxAmount;

      summary.push({
        name: matchedItem.name,
        price: Math.round(price * 100), // Stripe expects cents
        quantity: scannedItems[barcode],
        taxed: taxed,
        finalPrice: Math.round(finalPrice * 100) // Save tax in cents for return.js
      });
    }
  }

  summary.push({
    name: "Transaction Fee",
    price: 30,
    quantity: 1,
    taxed: false,
    finalPrice: 30
  });

  return summary;
}

async function initialize() {
  // Build cart object: { items: { itemName: quantity } }
  const cart = { items: {} };
  const manualItems = {};

  // Get full summary with tax info
  const summary = getScannedItemSummary();

  // Populate cart.items and manualItems using summary
  for (const item of summary) {
    // Skip transaction fee row for cart.items
    if (item.name === "Transaction Fee") continue;

    // Find barcode for manual items (if needed)
    let barcode = null;
    if (window.manualItems) {
      for (const [manualBarcode, manualDetails] of Object.entries(window.manualItems)) {
        if (manualDetails.name === item.name) {
          barcode = manualBarcode;
          manualItems[manualBarcode] = {
            ...manualDetails,
            taxed: item.taxed,
            taxAmount: item.taxAmount
          };
          break;
        }
      }
    }

    // Add to cart.items
    cart.items[item.name] = item.quantity;
  }

  cart.manualItems = manualItems; // Add manual items to cart

  localStorage.removeItem("pendingOrder");
  localStorage.setItem("completedCart", JSON.stringify(cart));

  let cartItems = summary.map(item => ({
    name: item.name,
    price: item.finalPrice,      // already includes tax if applicable
    quantity: item.quantity
  }));

  const fetchClientSecret = async () => {
    const response = await fetch("https://labelle-co-server.vercel.app/create-checkout-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ items: cartItems })
    });
    const { clientSecret } = await response.json();
    return clientSecret;
  };

  const checkout = await stripe.initEmbeddedCheckout({
    fetchClientSecret,
  });

  console.log(checkout)

  checkout.mount('#checkout');
}

async function loadOrders() {
  const container = document.getElementById('orders');
  container.innerHTML = 'Loading...';
  try {
    const res = await fetch('https://labelle-co-server.vercel.app/orders');
    const orders = await res.json();
    if (!orders.length) {
      container.innerHTML = '<p>No orders yet.</p>';
      return;
    }
    let html = '<table style="width:100%;min-width:400px;"><tr><th>Name</th><th>Phone</th><th>Email</th><th>Items</th><th>Status</th><th>Actions</th></tr>';
    for (const order of orders) {
      // Calculate profits
      let adminProfit = 0;
      let cosignerProfits = {}; // { email: { name, profit } }
      let itemsHtml = '';
      for (const [itemName, qty] of Object.entries(order.items)) {
        let found = false;
        for (const page in allitems) {
          for (const category in allitems[page]) {
            if (allitems[page][category][itemName]) {
              const itemObj = allitems[page][category][itemName];

              itemsHtml += `${itemName} (${qty})<br>`;
              found = true;
              break;
            }
          }
          if (found) break;
        }
        if (!found) {
          itemsHtml += `${itemName} (${qty})<br>`;
        }
      }

      html += `<tr>
        <td>${order.name}</td>
        <td>${order.phone}</td>
        <td>${order.email}</td>
        <td>${itemsHtml}</td>
        <td>
          ${order.orderType === 'buy' ? 'pickup' : order.orderType === 'hold' ? 'buying' : order.status}
        </td>
        <td>
          <button onclick="cancelOrder(${order.id})">close order (after scanning)</button>
        </td>
      </tr>`;
    }
    html += '</table>';
    container.innerHTML = html;
  } catch (err) {
    container.innerHTML = `<p style="color:red;">Failed to load orders: ${err.message}</p>`;
  }
}

// Cancel order function (copy from admin.js)
async function cancelOrder(orderId) {
  try {
    let orders = await (await fetch('https://labelle-co-server.vercel.app/orders')).json();
    let orderIndex = orders.findIndex(o => o.id === orderId);
    if (orderIndex === -1) throw new Error("Order not found.");
    let order = orders[orderIndex];

    orders.splice(orderIndex, 1);

    await fetch('https://labelle-co-server.vercel.app/orders', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(orders)
    });

    loadOrders();
  } catch (err) {
    alert("Failed to cancel order: " + err.message);
  }
}

document.addEventListener('DOMContentLoaded', loadOrders);

async function removeScannedItemsNoPay() {
  if (Object.keys(scannedItems).length === 0) {
    alert("No scanned items to remove.");
    return;
  }
  // Fetch latest inventory
  let inventory = await (await fetch(CLOUD_API_URL)).json();

  // Build a map of itemName → qty from scannedItems
  const itemQtyMap = {};
  for (const barcode in scannedItems) {
    for (const [page, categories] of Object.entries(inventory)) {
      for (const [category, items] of Object.entries(categories)) {
        for (const [itemName, details] of Object.entries(items)) {
          if (details.barcode === barcode) {
            itemQtyMap[itemName] = (itemQtyMap[itemName] || 0) + scannedItems[barcode];
            break;
          }
        }
      }
    }
  }

  // Remove items using acceptOrder logic (default to 'buy' orderType)
  for (const [itemName, qty] of Object.entries(itemQtyMap)) {
    let found = false;
    for (const page in inventory) {
      for (const category in inventory[page]) {
        if (inventory[page][category][itemName]) {
          let item = inventory[page][category][itemName];
          if ('stock' in item) {
            item.stock = Math.max(0, (item.stock || 0) - qty);
            // You can change 'buy' to 'hold' if needed for your workflow
            if ('itemsBought' in item) {
              item.itemsBought = (item.itemsBought || 0) - qty;
            }
          } else {
            delete inventory[page][category][itemName];
          }
          found = true;
          break;
        }
      }
      if (found) break;
    }
  }

  // Save updated inventory to the cloud
  await fetch(CLOUD_API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(inventory)
  });

  // Clear scanned items
  clearScannedBarcodes();
  alert("Scanned items removed from inventory.");
}

async function loadCustomers() {
  const customersTable = document.getElementById('customersTable');
  customersTable.innerHTML = 'Loading...';
  try {
    const res = await fetch('https://labelle-co-server.vercel.app/get-analytics');
    const analytics = await res.json();
    const customersObj = analytics.customers && typeof analytics.customers === 'object' ? analytics.customers : {};
    let html = `<table>
      <tr><th>Name</th><th>Email</th><th>Phone</th></tr>`;
    for (const [email, info] of Object.entries(customersObj)) {
      html += `<tr>
        <td>${info.name || ''}</td>
        <td>${email}</td>
        <td>${info.phone || ''}</td>
      </tr>`;
    }
    html += '</table>';
    customersTable.innerHTML = html;
  } catch (err) {
    customersTable.innerHTML = `<span style="color:red;">Failed to load customers: ${err.message}</span>`;
  }
}

function filterCustomers() {
  const input = document.getElementById("customerSearch");
  const filter = input.value.toLowerCase();
  const table = document.querySelector("#customersTable table");
  if (!table) return;
  const rows = table.getElementsByTagName("tr");
  for (let i = 1; i < rows.length; i++) { // skip header row
    const nameCell = rows[i].getElementsByTagName("td")[0];
    const emailCell = rows[i].getElementsByTagName("td")[1];
    const phoneCell = rows[i].getElementsByTagName("td")[2];
    let match = false;
    if (nameCell && (nameCell.textContent || nameCell.innerText).toLowerCase().includes(filter)) match = true;
    if (emailCell && (emailCell.textContent || emailCell.innerText).toLowerCase().includes(filter)) match = true;
    if (phoneCell && (phoneCell.textContent || phoneCell.innerText).toLowerCase().includes(filter)) match = true;
    rows[i].style.display = match ? "" : "none";
  }
}

document.addEventListener('DOMContentLoaded', loadCustomers);


async function populateCheckoutConsignorDropdown() {
  const dropdown = document.getElementById('checkoutConsignorDropdown');
  dropdown.innerHTML = '<option value="">-- Select Consignor --</option>';
  try {
    const res = await fetch('https://labelle-co-server.vercel.app/cosigners');
    const cosigners = await res.json();
    cosigners.forEach(c => {
      const option = document.createElement('option');
      option.value = JSON.stringify({ name: c.name, email: c.email });
      option.textContent = `${c.name} (${c.email})`;
      dropdown.appendChild(option);
    });
  } catch (err) {
    dropdown.innerHTML = '<option value="">Error loading cosigners</option>';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  loadCustomers();
  populateCheckoutConsignorDropdown();
});

function addManualItemToScannedList(event) {
  event.preventDefault();
  const name = document.getElementById('checkoutName').value.trim();
  const price = Number(document.getElementById('checkoutPrice').value);
  const qty = Number(document.getElementById('checkoutQty').value);
  let profitSplit = document.getElementById('checkoutProfitSplit').value;
  const cosignerData = JSON.parse(document.getElementById('checkoutConsignorDropdown').value || '{}');
  if (!name || !price || !qty) {
    document.getElementById('checkoutMsg').textContent = "Fill out all fields.";
    return false;
  }
  // If no cosigner, force profitSplit to 100/0
  if (!cosignerData.email) profitSplit = "100/0";

  // Use a synthetic barcode to avoid collision with real barcodes
  const manualBarcode = "manual-" + Date.now() + "-" + Math.floor(Math.random() * 1000000);

  // Store manual item in scannedItems with all details
  scannedItems[manualBarcode] = qty;
  if (!window.manualItems) window.manualItems = {};
  window.manualItems[manualBarcode] = {
    name,
    price,
    profitSplit,
    cosignerName: cosignerData.name,
    cosignerEmail: cosignerData.email
  };

  updateScannedList();
  document.getElementById('checkoutForm').reset();
  document.getElementById('checkoutMsg').textContent = "";
  return false;
}

</script>
</body>
</html>